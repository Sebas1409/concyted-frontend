<div class="researcher-management-page">
    <div class="researcher-management-page">
        <app-intro-card title="Directorio de Investigadores"
            subtitle="Administra, supervisa y audita los perfiles registrados en la plataforma. Accede a herramientas de edición, control de accesos y gestión de estados.">
        </app-intro-card>

        <!-- Tabs -->
        <div class="tabs-container">
            <button class="tab-btn" [class.active]="activeTab === 'directory'" (click)="toggleTab('directory')">
                Directorio General
            </button>
            <button class="tab-btn" [class.active]="activeTab === 'requests'" (click)="toggleTab('requests')">
                Solicitudes de Baja <span class="badge">02</span>
            </button>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Search for Requests -->
            <div class="search-bar" *ngIf="activeTab === 'requests'">
                <div class="input-wrapper">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" placeholder="Buscar por nombre, correo o ID" [(ngModel)]="searchTerm"
                        (input)="onSearchChange()">
                </div>
                <button class="btn-search" (click)="search()">
                    Buscar
                </button>
            </div>

            <!-- New Filters for Directory -->
            <div class="filters-panel" *ngIf="activeTab === 'directory'">
                <div class="search-row-main">
                    <div class="input-wrapper expanded">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#64748B" stroke-width="2"
                            style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%);">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <input type="text" [(ngModel)]="filterGeneric"
                            placeholder="Buscar por nombres, apellidos, código Renacyt o DNI..."
                            (keyup.enter)="search()"
                            style="width: 100%; padding: 12px 12px 12px 40px; border: 1px solid #E2E8F0; border-radius: 6px;">
                    </div>
                    <button class="btn-save" (click)="search()"
                        style="margin-left: 12px; height: 42px; display: flex; align-items: center; gap: 8px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        Buscar
                    </button>
                </div>

                <div class="filters-grid"
                    style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 16px; align-items: end;">
                    <div class="form-group">
                        <label
                            style="font-size: 13px; font-weight: 500; color: #334155; margin-bottom: 6px; display: block;">Lugar
                            de residencia</label>
                        <select [(ngModel)]="filterRegion"
                            style="width: 100%; padding: 8px; border: 1px solid #E2E8F0; border-radius: 6px;">
                            <option value="">Todos</option>
                            <option *ngFor="let dep of departments" [value]="dep.id">{{ dep.nombre }}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label
                            style="font-size: 13px; font-weight: 500; color: #334155; margin-bottom: 6px; display: block;">Área
                            OCDE</label>
                        <select [(ngModel)]="filterArea"
                            style="width: 100%; padding: 8px; border: 1px solid #E2E8F0; border-radius: 6px;">
                            <option value="">Todas</option>
                            <option *ngFor="let area of areas" [value]="area.idArea">{{ area.nombre }}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label
                            style="font-size: 13px; font-weight: 500; color: #334155; margin-bottom: 6px; display: block;">Grado
                            Sunedu</label>
                        <div class="radio-row" style="display: flex; gap: 12px;">
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 13px;"><input
                                    type="radio" name="grade" [(ngModel)]="filterSunedu" value="Doctor"> Doctor</label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 13px;"><input
                                    type="radio" name="grade" [(ngModel)]="filterSunedu" value="Maestro">
                                Maestro</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label
                            style="font-size: 13px; font-weight: 500; color: #334155; margin-bottom: 6px; display: block;">Nacionalidad</label>
                        <div class="radio-row" style="display: flex; gap: 12px;">
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 13px;"><input
                                    type="radio" name="nation" [(ngModel)]="filterNationality" value="peruana">
                                Peruana</label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 13px;"><input
                                    type="radio" name="nation" [(ngModel)]="filterNationality" value="extranjera">
                                Extranjera</label>
                        </div>
                    </div>
                </div>
                <div class="filter-actions-row" style="display: flex; justify-content: flex-end; margin-top: 12px;">
                    <button
                        style="background: none; border: none; color: #334155; font-size: 13px; text-decoration: underline; cursor: pointer;"
                        (click)="clearFilters()">Limpiar filtros</button>
                </div>
            </div>

            <!-- Actions Row (Export) -->
            <div class="actions-row" style="margin-top: 16px;">
                <div class="export-actions">
                    <!-- Keep export buttons -->
                    <button class="btn-outline" (click)="copyToClipboard()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                        Copy
                    </button>
                    <button class="btn-outline" (click)="downloadExcel()">Excel</button>
                    <button class="btn-outline" (click)="downloadCSV()">CSV</button>
                    <button class="btn-outline" (click)="printPDF()">PDF</button>
                </div>
            </div>

            <!-- Table - Directory -->
            <div class="table-responsive" *ngIf="activeTab === 'directory'" style="margin-top: 20px;">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 60px;">N° ⇅</th>
                            <th style="width: 80px;">Sexo ⇅</th>
                            <th>Nombre y Datos ⇅</th>
                            <th>Resumen Profesional ⇅</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let item of paginatedResearchers; let i = index">
                            <td>{{ (currentPage - 1) * pageSize + i + 1 }}</td>
                            <td style="text-align: center;">
                                <div *ngIf="item.gender === 'M'"
                                    style="background: #E0F2FE; width: 32px; height: 32px; border-radius: 50%; display: grid; place-items: center; margin: 0 auto; color: #0EA5E9;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <circle cx="12" cy="5" r="3"></circle>
                                        <path d="M12 8v13M9 13l3 3 3-3"></path>
                                    </svg>
                                </div>
                                <div *ngIf="item.gender === 'F'"
                                    style="background: #FCE7F3; width: 32px; height: 32px; border-radius: 50%; display: grid; place-items: center; margin: 0 auto; color: #EC4899;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <circle cx="12" cy="5" r="3"></circle>
                                        <path d="M12 8v9M9 17l3 3 3-3"></path>
                                        <path d="M9 13h6"></path>
                                    </svg>
                                </div>
                            </td>
                            <td>
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <span style="font-weight: 600; color: #005470;">{{ item.name }}</span>
                                    <div
                                        style="display: flex; flex-direction: column; font-size: 13px; color: #64748B;">
                                        <span *ngIf="item.institution"><svg width="12" height="12" viewBox="0 0 24 24"
                                                fill="none" stroke="currentColor" stroke-width="2"
                                                style="margin-right: 4px;">
                                                <path d="M3 21h18M5 21V7l8-4 8 4v14M8 21v-4h8v4" />
                                            </svg> {{ item.institution }}</span>
                                        <span *ngIf="item.region" style="margin-top: 2px;"><svg width="12" height="12"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                style="margin-right: 4px;">
                                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                                <circle cx="12" cy="10" r="3"></circle>
                                            </svg> {{ item.region }}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <p
                                    style="font-size: 13px; color: #475569; line-height: 1.5; margin: 0; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
                                    {{ item.summary || 'Sin resumen profesional.' }}
                                </p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Table - Requests -->
            <div class="table-responsive" *ngIf="activeTab === 'requests'">
                <table>
                    <thead>
                        <tr>
                            <th style="min-width: 100px;">ID ⇅</th>
                            <th>Fecha ⇅</th>
                            <th>Investigador</th>
                            <th>Motivo ⇅</th>
                            <th>Estado ⇅</th>
                            <th>Accion ⇅</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let req of paginatedRequests">
                            <td>{{ req.id }}</td>
                            <td>{{ req.date | dateFormat }}</td>
                            <td class="name-cell">{{ req.researcherName }}</td>
                            <td>{{ req.reason }}</td>
                            <td>
                                <span class="status-badge"
                                    [class.pending]="req.status === 'Pendiente' || req.status === 'PENDIENTE'"
                                    [class.cancelled]="req.status === 'Anulado' || req.status === 'ANULADO'"
                                    [class.approved]="req.status === 'Aprobado' || req.status === 'APROBADA'">
                                    <span class="dot"></span> {{ req.status }}
                                </span>
                            </td>
                            <td>
                                <button class="btn-review" (click)="openReviewModal(req)">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                                    </svg>
                                    Revisar
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>


            <!-- Pagination -->
            <div class="pagination-container">
                <div class="items-per-page">
                    <span>Mostrar</span>
                    <select [(ngModel)]="pageSize" (change)="setPage(1)">
                        <option [value]="10">10</option>
                        <option [value]="20">20</option>
                        <option [value]="50">50</option>
                    </select>
                    <span>elementos de {{ totalItemsDisplay }}</span>
                </div>

                <div class="page-controls">
                    <button class="btn-page text" (click)="setPage(currentPage - 1)"
                        [disabled]="currentPage === 1">Anterior</button>

                    <button *ngFor="let p of pagesArray" class="btn-page number" [class.active]="p === currentPage"
                        (click)="setPage(p)">
                        {{ p }}
                    </button>

                    <button class="btn-page text" (click)="setPage(currentPage + 1)"
                        [disabled]="currentPage === totalPages">Siguiente</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Access Management Modal -->
    <app-form-modal *ngIf="showAccessModal" title="Gestión de Accesos y Credenciales" (close)="showAccessModal = false"
        (save)="saveAccess()" saveLabel="Guardar Cambios">

        <p class="modal-description">Administra las credenciales de ingreso y define el estado de actividad de la
            cuenta.</p>

        <div class="form-grid">
            <div class="form-group">
                <label>Nombre de Usuario</label>
                <input type="text" [(ngModel)]="accessForm.username" disabled class="input-disabled">
            </div>
            <div class="form-group">
                <label>Correo</label>
                <input type="text" [(ngModel)]="accessForm.email" disabled class="input-disabled">
            </div>
            <div class="form-group full-width">
                <label>Nombre Completo</label>
                <input type="text" [(ngModel)]="accessForm.fullName" disabled class="input-disabled">
            </div>

            <div class="form-group checkbox-align">
                <label class="custom-checkbox-container">
                    <input type="checkbox" [(ngModel)]="accessForm.forceChange">
                    <span class="checkmark"></span>
                    <span class="label-text">Forzar cambio</span>
                </label>
                <span
                    style="display: block; font-size: 14px; font-weight: 500; color: #334155; margin-bottom: 8px;">Forzar
                    cambio de clave</span>
            </div>

            <div class="form-group">
                <div class="toggle-switch-container">
                    <label style="margin-bottom: 8px; display: block;">Cuenta Activa</label>
                    <div class="toggle-wrapper">
                        <label class="switch">
                            <input type="checkbox" [(ngModel)]="accessForm.active">
                            <span class="slider round"></span>
                        </label>
                        <span class="status-text">{{ accessForm.active ? 'Activa' : 'Inactiva' }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-actions">
            <button class="btn-cancel" (click)="showAccessModal = false">Cancelar</button>
            <button class="btn-save" (click)="saveAccess()">Guardar Cambios</button>
        </div>
    </app-form-modal>

    <!-- Edit Profile Modal -->
    <app-form-modal *ngIf="showEditModal" title="Actualizar Datos del Perfil" (close)="showEditModal = false">

        <p class="modal-description">Modifica la información de contacto y datos complementarios del investigador</p>

        <div class="form-grid">
            <div class="form-group full-width">
                <label>Nombre Completo</label>
                <input type="text" [(ngModel)]="editForm.fullName" disabled class="input-disabled">
            </div>
            <div class="form-group">
                <label>Correo Electrónico</label>
                <input type="email" [(ngModel)]="editForm.email">
            </div>
            <div class="form-group">
                <label>Fecha de Nacimiento</label>
                <input type="text" [(ngModel)]="editForm.birthDate" placeholder="dd/mm/aaaa">
            </div>

            <div class="form-group full-width">
                <label style="display: block; margin-bottom: 8px;">Sexo</label>
                <div class="radio-group">
                    <label class="radio-container">
                        <input type="radio" name="gender" value="M" [(ngModel)]="editForm.gender">
                        <span class="radio-mark"></span>
                        <span class="radio-label">Masculino</span>
                    </label>
                    <label class="radio-container">
                        <input type="radio" name="gender" value="F" [(ngModel)]="editForm.gender">
                        <span class="radio-mark"></span>
                        <span class="radio-label">Femenino</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="modal-actions">
            <button class="btn-cancel" (click)="showEditModal = false">Cancelar</button>
            <button class="btn-save" (click)="saveEdit()">Guardar Cambios</button>
        </div>
    </app-form-modal>

    <!-- Review Request Modal -->
    <app-form-modal *ngIf="showReviewModal && selectedRequest" title="Atender Solicitud de Anulación"
        (close)="showReviewModal = false">

        <p class="modal-description">Revisa los motivos expuestos por el investigador y determina la procedencia de la
            baja definitiva de la cuenta.</p>

        <div class="form-grid">
            <div class="form-group full-width">
                <label>Investigador</label>
                <input type="text" [value]="selectedRequest.researcherName" disabled class="input-disabled">
            </div>
            <div class="form-group">
                <label>Documento</label>
                <input type="text" [value]="selectedRequest.document" disabled class="input-disabled">
            </div>
            <div class="form-group">
                <label>Correo</label>
                <input type="text" [value]="selectedRequest.email" disabled class="input-disabled">
            </div>
            <div class="form-group full-width">
                <label>Ticket / ID Solicitud</label>
                <input type="text" [value]="selectedRequest.ticketId" disabled class="input-disabled">
            </div>
            <div class="form-group full-width">
                <label>Motivo de investigador</label>
                <textarea class="input-disabled" disabled rows="3">{{ selectedRequest.researcherReasonFull }}</textarea>
            </div>
            <div class="form-group full-width">
                <label>Observación del Administrador <span style="color: red;">*</span></label>
                <textarea rows="3" placeholder="Indica el motivo de la aprobación o rechazo de la solicitud..."
                    [(ngModel)]="reviewForm.adminObservation" required #adminObs="ngModel"
                    [class.input-error]="adminObs.invalid && (adminObs.dirty || adminObs.touched)"></textarea>
            </div>
        </div>

        <div class="modal-actions">
            <button class="btn-cancel" (click)="showReviewModal = false">Cancelar</button>
            <button class="btn-save" (click)="adminObs.control.markAsTouched(); approveDerecognition(!!adminObs.valid)"
                [disabled]="selectedRequest.status === 'APROBADA' || selectedRequest.status === 'Aprobado'"
                [style.opacity]="(selectedRequest.status === 'APROBADA' || selectedRequest.status === 'Aprobado') ? '0.5' : '1'">
                Aprobar Anulación
            </button>
        </div>
    </app-form-modal>