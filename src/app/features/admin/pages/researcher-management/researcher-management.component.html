<div class="researcher-management-page">
    <div class="researcher-management-page">
        <app-intro-card title="Directorio de Investigadores"
            subtitle="Administra, supervisa y audita los perfiles registrados en la plataforma. Accede a herramientas de edición, control de accesos y gestión de estados.">
        </app-intro-card>

        <!-- Tabs -->
        <div class="tabs-container">
            <button class="tab-btn" [class.active]="activeTab === 'directory'" (click)="toggleTab('directory')">
                Directorio General
            </button>
            <button class="tab-btn" [class.active]="activeTab === 'requests'" (click)="toggleTab('requests')">
                Solicitudes de Baja <span class="badge">02</span>
            </button>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Search -->
            <div class="search-bar">
                <div class="input-wrapper">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" placeholder="Buscar por Título, nombre etc" [(ngModel)]="searchTerm"
                        (input)="onSearchChange()">
                </div>
                <button class="btn-search" (click)="search()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    Buscar
                </button>
            </div>

            <!-- Actions Row -->
            <div class="actions-row">
                <div class="export-actions">
                    <button class="btn-outline" (click)="copyToClipboard()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                        Copy
                    </button>
                    <button class="btn-outline" (click)="downloadExcel()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="8" y1="13" x2="16" y2="13"></line>
                            <line x1="8" y1="17" x2="16" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        Excel
                    </button>
                    <button class="btn-outline" (click)="downloadCSV()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="12" y1="18" x2="12" y2="12"></line>
                            <line x1="9" y1="15" x2="15" y2="15"></line>
                        </svg>
                        CSV
                    </button>
                    <button class="btn-outline" (click)="printPDF()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="12" y1="18" x2="12" y2="12"></line>
                            <line x1="9" y1="15" x2="15" y2="15"></line>
                        </svg>
                        PDF
                    </button>
                </div>
                <!-- <button class="btn-outline ms-auto">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                    </svg>
                    Filtros Avanzados
                </button> -->
            </div>

            <!-- Table - Directory -->
            <div class="table-responsive" *ngIf="activeTab === 'directory'">
                <table>
                    <thead>
                        <tr>
                            <th style="min-width: 120px;">ID ⇅</th>
                            <th>Genero ⇅</th>
                            <th>Investigador ⇅</th>
                            <th>Grado ⇅</th>
                            <th>Región ⇅</th>
                            <th>Institución Principal ⇅</th>
                            <th>Regina ⇅</th>
                            <th>Estado ⇅</th>
                            <th>Usuario ⇅</th>
                            <th style="width: 50px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let item of paginatedResearchers; let i = index">
                            <td>{{ item.id }}</td>
                            <td>{{ item.gender }}</td>
                            <td class="name-cell">{{ item.name }}</td>
                            <td>{{ item.degree }}</td>
                            <td>{{ item.region }}</td>
                            <td>{{ item.institution }}</td>
                            <td>{{ item.regina }}</td>
                            <td>{{ item.status }}</td>
                            <td><a href="#" class="user-link">{{ item.userId }}</a></td>
                            <td class="action-cell">
                                <button class="btn-more" (click)="toggleMenu(item, i, $event)">...</button>

                                <!-- Dropdown Menu -->
                                <div class="dropdown-menu" *ngIf="activeMenuId === (item.id + '-' + i)">
                                    <button class="menu-item"
                                        [routerLink]="['/admin/researchers', item.id, 'public-profile']">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                            <circle cx="12" cy="12" r="3"></circle>
                                        </svg>
                                        <div>
                                            <span>Ver Perfil Público</span>
                                            <small>Vista previa del CV en el portal CTI Vitae.</small>
                                        </div>
                                    </button>
                                    <button class="menu-item">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                            <polyline points="14 2 14 8 20 8"></polyline>
                                            <line x1="12" y1="18" x2="12" y2="12"></line>
                                            <line x1="9" y1="15" x2="15" y2="15"></line>
                                        </svg>
                                        <div>
                                            <span>Descargar Ficha (PDF)</span>
                                            <small>Expediente confidencial completo.</small>
                                        </div>
                                    </button>
                                    <button class="menu-item">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                            <polyline points="14 2 14 8 20 8"></polyline>
                                            <line x1="8" y1="13" x2="16" y2="13"></line>
                                            <line x1="8" y1="17" x2="16" y2="17"></line>
                                            <polyline points="10 9 9 9 8 9"></polyline>
                                        </svg>
                                        <div>
                                            <span>Descargar Datos (Excel)</span>
                                            <small>Exportar datos sensibles</small>
                                        </div>
                                    </button>
                                    <button class="menu-item" (click)="openAccessModal(item)">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                        </svg>
                                        <div>
                                            <span>Gestionar Accesos</span>
                                            <small>Restablecer contraseña y estado</small>
                                        </div>
                                    </button>
                                    <button class="menu-item" (click)="openEditModal(item)">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                        <div>
                                            <span>Editar investigador</span>
                                            <small>Modificar datos personales</small>
                                        </div>
                                    </button>
                                    <button class="menu-item danger">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="15" y1="9" x2="9" y2="15"></line>
                                            <line x1="9" y1="9" x2="15" y2="15"></line>
                                        </svg>
                                        <div>
                                            <span>Anular Cuenta</span>
                                            <small>Dar de baja al investigador</small>
                                        </div>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Table - Requests -->
            <div class="table-responsive" *ngIf="activeTab === 'requests'">
                <table>
                    <thead>
                        <tr>
                            <th style="min-width: 100px;">ID ⇅</th>
                            <th>Fecha ⇅</th>
                            <th>Investigador</th>
                            <th>Motivo ⇅</th>
                            <th>Estado ⇅</th>
                            <th>Accion ⇅</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let req of paginatedRequests">
                            <td>{{ req.id }}</td>
                            <td>{{ req.date | dateFormat }}</td>
                            <td class="name-cell">{{ req.researcherName }}</td>
                            <td>{{ req.reason }}</td>
                            <td>
                                <span class="status-badge"
                                    [class.pending]="req.status === 'Pendiente' || req.status === 'PENDIENTE'"
                                    [class.cancelled]="req.status === 'Anulado' || req.status === 'ANULADO'"
                                    [class.approved]="req.status === 'Aprobado' || req.status === 'APROBADA'">
                                    <span class="dot"></span> {{ req.status }}
                                </span>
                            </td>
                            <td>
                                <button class="btn-review" (click)="openReviewModal(req)">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                                    </svg>
                                    Revisar
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>


            <!-- Pagination -->
            <div class="pagination-container">
                <div class="items-per-page">
                    <span>Mostrar</span>
                    <select [(ngModel)]="pageSize" (change)="setPage(1)">
                        <option [value]="10">10</option>
                        <option [value]="20">20</option>
                        <option [value]="50">50</option>
                    </select>
                    <span>elementos de {{ totalItemsDisplay }}</span>
                </div>

                <div class="page-controls">
                    <button class="btn-page text" (click)="setPage(currentPage - 1)"
                        [disabled]="currentPage === 1">Anterior</button>

                    <button *ngFor="let p of pagesArray" class="btn-page number" [class.active]="p === currentPage"
                        (click)="setPage(p)">
                        {{ p }}
                    </button>

                    <button class="btn-page text" (click)="setPage(currentPage + 1)"
                        [disabled]="currentPage === totalPages">Siguiente</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Access Management Modal -->
    <app-form-modal *ngIf="showAccessModal" title="Gestión de Accesos y Credenciales" (close)="showAccessModal = false"
        (save)="saveAccess()" saveLabel="Guardar Cambios">

        <p class="modal-description">Administra las credenciales de ingreso y define el estado de actividad de la
            cuenta.</p>

        <div class="form-grid">
            <div class="form-group">
                <label>Nombre de Usuario</label>
                <input type="text" [(ngModel)]="accessForm.username" disabled class="input-disabled">
            </div>
            <div class="form-group">
                <label>Correo</label>
                <input type="text" [(ngModel)]="accessForm.email" disabled class="input-disabled">
            </div>
            <div class="form-group full-width">
                <label>Nombre Completo</label>
                <input type="text" [(ngModel)]="accessForm.fullName" disabled class="input-disabled">
            </div>

            <div class="form-group checkbox-align">
                <label class="custom-checkbox-container">
                    <input type="checkbox" [(ngModel)]="accessForm.forceChange">
                    <span class="checkmark"></span>
                    <span class="label-text">Forzar cambio</span>
                </label>
                <span
                    style="display: block; font-size: 14px; font-weight: 500; color: #334155; margin-bottom: 8px;">Forzar
                    cambio de clave</span>
            </div>

            <div class="form-group">
                <div class="toggle-switch-container">
                    <label style="margin-bottom: 8px; display: block;">Cuenta Activa</label>
                    <div class="toggle-wrapper">
                        <label class="switch">
                            <input type="checkbox" [(ngModel)]="accessForm.active">
                            <span class="slider round"></span>
                        </label>
                        <span class="status-text">{{ accessForm.active ? 'Activa' : 'Inactiva' }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-actions">
            <button class="btn-cancel" (click)="showAccessModal = false">Cancelar</button>
            <button class="btn-save" (click)="saveAccess()">Guardar Cambios</button>
        </div>
    </app-form-modal>

    <!-- Edit Profile Modal -->
    <app-form-modal *ngIf="showEditModal" title="Actualizar Datos del Perfil" (close)="showEditModal = false">

        <p class="modal-description">Modifica la información de contacto y datos complementarios del investigador</p>

        <div class="form-grid">
            <div class="form-group full-width">
                <label>Nombre Completo</label>
                <input type="text" [(ngModel)]="editForm.fullName" disabled class="input-disabled">
            </div>
            <div class="form-group">
                <label>Correo Electrónico</label>
                <input type="email" [(ngModel)]="editForm.email">
            </div>
            <div class="form-group">
                <label>Fecha de Nacimiento</label>
                <input type="text" [(ngModel)]="editForm.birthDate" placeholder="dd/mm/aaaa">
            </div>

            <div class="form-group full-width">
                <label style="display: block; margin-bottom: 8px;">Sexo</label>
                <div class="radio-group">
                    <label class="radio-container">
                        <input type="radio" name="gender" value="M" [(ngModel)]="editForm.gender">
                        <span class="radio-mark"></span>
                        <span class="radio-label">Masculino</span>
                    </label>
                    <label class="radio-container">
                        <input type="radio" name="gender" value="F" [(ngModel)]="editForm.gender">
                        <span class="radio-mark"></span>
                        <span class="radio-label">Femenino</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="modal-actions">
            <button class="btn-cancel" (click)="showEditModal = false">Cancelar</button>
            <button class="btn-save" (click)="saveEdit()">Guardar Cambios</button>
        </div>
    </app-form-modal>

    <!-- Review Request Modal -->
    <app-form-modal *ngIf="showReviewModal && selectedRequest" title="Atender Solicitud de Anulación"
        (close)="showReviewModal = false">

        <p class="modal-description">Revisa los motivos expuestos por el investigador y determina la procedencia de la
            baja definitiva de la cuenta.</p>

        <div class="form-grid">
            <div class="form-group full-width">
                <label>Investigador</label>
                <input type="text" [value]="selectedRequest.researcherName" disabled class="input-disabled">
            </div>
            <div class="form-group">
                <label>Documento</label>
                <input type="text" [value]="selectedRequest.document" disabled class="input-disabled">
            </div>
            <div class="form-group">
                <label>Correo</label>
                <input type="text" [value]="selectedRequest.email" disabled class="input-disabled">
            </div>
            <div class="form-group full-width">
                <label>Ticket / ID Solicitud</label>
                <input type="text" [value]="selectedRequest.ticketId" disabled class="input-disabled">
            </div>
            <div class="form-group full-width">
                <label>Motivo de investigador</label>
                <textarea class="input-disabled" disabled rows="3">{{ selectedRequest.researcherReasonFull }}</textarea>
            </div>
            <div class="form-group full-width">
                <label>Observación del Administrador <span style="color: red;">*</span></label>
                <textarea rows="3" placeholder="Indica el motivo de la aprobación o rechazo de la solicitud..."
                    [(ngModel)]="reviewForm.adminObservation" required #adminObs="ngModel"
                    [class.input-error]="adminObs.invalid && (adminObs.dirty || adminObs.touched)"></textarea>
            </div>
        </div>

        <div class="modal-actions">
            <button class="btn-cancel" (click)="showReviewModal = false">Cancelar</button>
            <button class="btn-save" (click)="adminObs.control.markAsTouched(); approveDerecognition(!!adminObs.valid)"
                [disabled]="selectedRequest.status === 'APROBADA' || selectedRequest.status === 'Aprobado'"
                [style.opacity]="(selectedRequest.status === 'APROBADA' || selectedRequest.status === 'Aprobado') ? '0.5' : '1'">
                Aprobar Anulación
            </button>
        </div>
    </app-form-modal>