<div class="researcher-management-page">
    <app-intro-card title="Directorio de Investigadores"
        subtitle="Administra, supervisa y audita los perfiles registrados en la plataforma. Accede a herramientas de edición, control de accesos y gestión de estados.">
    </app-intro-card>

    <!-- Tabs -->
    <div class="tabs-container">
        <button class="tab-btn" [class.active]="activeTab === 'directory'" (click)="toggleTab('directory')">
            Directorio General
        </button>
        <button *ngIf="canEdit" class="tab-btn" [class.active]="activeTab === 'requests'"
            (click)="toggleTab('requests')">
            Solicitudes de Baja <span class="badge">02</span>
        </button>
    </div>

    <!-- Content Area -->
    <div class="content-area">
        <!-- Main Search Controls -->
        <div class="main-controls">
            <div class="search-row">
                <div class="search-wrapper">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#64748B" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" [(ngModel)]="filterGeneric" (keyup.enter)="search()"
                        placeholder="Buscar por Título, nombre etc">
                </div>
                <button class="btn-search-main" (click)="search()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    Buscar
                </button>
            </div>

            <!-- Consolidated Actions Row (Aligns with search and table) -->
            <div class="actions-row-grid" style="margin-top: 24px;">
                <div class="left-actions">
                    <div class="export-buttons">
                        <button class="btn-export" (click)="copyToClipboard()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2">
                                </path>
                                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                            </svg>
                            Copy
                        </button>
                        <button class="btn-export" (click)="downloadExcel()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="3" y1="9" x2="21" y2="9"></line>
                                <line x1="9" y1="21" x2="9" y2="9"></line>
                            </svg>
                            Excel
                        </button>
                        <button class="btn-export" (click)="downloadCSV()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                            </svg>
                            CSV
                        </button>
                        <button class="btn-export" (click)="printPDF()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                            </svg>
                            PDF
                        </button>
                    </div>
                </div>

                <div class="results-info">
                    <span class="count">{{ totalItemsDisplay }}</span> resultados encontrados
                </div>
            </div>
        </div>

        <!-- Table - Directory -->
        <div class="table-container" *ngIf="activeTab === 'directory'">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th (click)="toggleSort('userId')" style="cursor: pointer;">Usuario
                            {{ sortField === 'userId' ? (sortOrder === 'asc' ? '↑' : '↓') : '⇅' }}
                        </th>
                        <th (click)="toggleSort('gender')" style="cursor: pointer; text-align: center;">Género
                            {{ sortField === 'gender' ? (sortOrder === 'asc' ? '↑' : '↓') : '⇅' }}
                        </th>
                        <th (click)="toggleSort('name')" style="cursor: pointer;">Investigador
                            {{ sortField === 'name' ? (sortOrder === 'asc' ? '↑' : '↓') : '⇅' }}
                        </th>
                        <th (click)="toggleSort('email')" style="cursor: pointer;">Correo
                            {{ sortField === 'email' ? (sortOrder === 'asc' ? '↑' : '↓') : '⇅' }}
                        </th>
                        <th (click)="toggleSort('degree')" style="cursor: pointer;">Grado
                            {{ sortField === 'degree' ? (sortOrder === 'asc' ? '↑' : '↓') : '⇅' }}
                        </th>
                        <th (click)="toggleSort('region')" style="cursor: pointer;">Región
                            {{ sortField === 'region' ? (sortOrder === 'asc' ? '↑' : '↓') : '⇅' }}
                        </th>
                        <th (click)="toggleSort('institution')" style="cursor: pointer;">Institución Principal
                            {{ sortField === 'institution' ? (sortOrder === 'asc' ? '↑' : '↓') : '⇅' }}
                        </th>
                        <th (click)="toggleSort('status')" style="cursor: pointer;">Estado
                            {{ sortField === 'status' ? (sortOrder === 'asc' ? '↑' : '↓') : '⇅' }}
                        </th>
                        <th class="text-center">Doc.</th>
                        <th style="width: 40px;"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let item of paginatedResearchers; let i = index"
                        [class.active-row]="selectedItemForMenu === item">
                        <td>
                            <span class="user-id-text">{{ item.userId }}</span>
                        </td>
                        <td class="text-center">
                            <div class="gender-display"
                                style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                                <div class="gender-icon" [style.color]="item.gender === 'M' ? '#3B82F6' : '#EC4899'">
                                    <!-- Mars Symbol (Male) -->
                                    <svg *ngIf="item.gender === 'M'" width="20" height="20" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <circle cx="9" cy="15" r="6"></circle>
                                        <line x1="14" y1="10" x2="20" y2="4"></line>
                                        <polyline points="15 4 20 4 20 9"></polyline>
                                    </svg>
                                    <!-- Venus Symbol (Female) -->
                                    <svg *ngIf="item.gender === 'F'" width="20" height="20" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <circle cx="12" cy="9" r="6"></circle>
                                        <line x1="12" y1="15" x2="12" y2="22"></line>
                                        <line x1="9" y1="19" x2="15" y2="19"></line>
                                    </svg>
                                </div>
                                <span style="font-size: 11px; font-weight: 500; color: #64748B;">
                                    {{ item.sexName }}
                                </span>
                            </div>
                        </td>
                        <td>
                            <div class="researcher-cell">
                                <span class="full-name clickable" (click)="viewPublicProfile(item)">{{ item.name |
                                    capitalize }}</span>
                            </div>
                        </td>
                        <td>{{ item.email || '---' }}</td>
                        <td>{{ item.degree || '---' }}</td>
                        <td>{{ item.region || '---' }}</td>
                        <td>{{ item.institution || '---' }}</td>
                        <td>
                            <span class="status-chip" [class.active]="item.status === 'Activo'"
                                [class.inactive]="item.status === 'Inactivo'">
                                {{ item.status }}
                            </span>
                        </td>
                        <td class="text-center">
                            <button *ngIf="item.docToken" (click)="viewDocument(item)" class="btn-file-preview"
                                title="Haz click para visualizar">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                </svg>
                            </button>
                            <span *ngIf="!item.docToken" style="color: #94a3b8;">---</span>
                        </td>
                        <td class="action-cell">
                            <button class="btn-more" (click)="toggleDropdown($event, item)">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="1.5"></circle>
                                    <circle cx="19" cy="12" r="1.5"></circle>
                                    <circle cx="5" cy="12" r="1.5"></circle>
                                </svg>
                            </button>

                            <!-- Dropdown Menu -->
                            <div class="dropdown-menu-modern" *ngIf="selectedItemForMenu === item">
                                <button class="menu-item" (click)="viewPublicProfile(item)">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                    </svg>
                                    <div>
                                        <span>Ver Perfil Público</span>
                                        <small>Vista previa del CV en el portal CTI Vitae.</small>
                                    </div>
                                </button>
                                <button class="menu-item" (click)="downloadResearcherPDF(item)">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                        <text x="7" y="18" font-size="6" font-family="Arial" font-weight="bold"
                                            fill="currentColor">PDF</text>
                                    </svg>
                                    <div>
                                        <span>Descargar Ficha (PDF)</span>
                                        <small>Expediente confidencial completo.</small>
                                    </div>
                                </button>
                                <button class="menu-item" (click)="downloadResearcherExcel(item)">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="3" y1="9" x2="21" y2="9"></line>
                                        <line x1="3" y1="15" x2="21" y2="15"></line>
                                        <line x1="9" y1="3" x2="9" y2="21"></line>
                                    </svg>
                                    <div>
                                        <span>Descargar Datos (Excel)</span>
                                        <small>Exportar datos sensibles</small>
                                    </div>
                                </button>
                                <button *ngIf="canEdit" class="menu-item" (click)="manageAccess(item)">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                        <circle cx="12" cy="11" r="2"></circle>
                                        <path d="M12 13v2"></path>
                                    </svg>
                                    <div>
                                        <span>Gestionar Accesos</span>
                                        <small>Restablecer contraseña y estado</small>
                                    </div>
                                </button>
                                <button *ngIf="canEdit" class="menu-item" (click)="editResearcher(item)">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                    <div>
                                        <span>Editar investigador</span>
                                        <small>Modificar datos personales</small>
                                    </div>
                                </button>
                                <button *ngIf="canEdit" class="menu-item danger" (click)="cancelAccount(item)">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                                    </svg>
                                    <div>
                                        <span>Anular Cuenta</span>
                                        <small>Dar de baja al investigador</small>
                                    </div>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Table - Requests -->
        <div class="table-container" *ngIf="activeTab === 'requests'">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th style="width: 100px;">ID</th>
                        <th>Fecha</th>
                        <th>Investigador</th>
                        <th>Motivo</th>
                        <th class="text-center">Estado</th>
                        <th class="text-center" style="width: 120px;">Acción</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let req of paginatedRequests">
                        <td>{{ req.id }}</td>
                        <td>{{ req.date | dateFormat }}</td>
                        <td class="name-cell">
                            <span class="full-name">{{ req.researcherName }}</span>
                        </td>
                        <td>{{ req.reason }}</td>
                        <td class="text-center">
                            <span class="status-badge"
                                [class.pending]="req.status === 'Pendiente' || req.status === 'PENDIENTE'"
                                [class.cancelled]="req.status === 'Anulado' || req.status === 'ANULADO'"
                                [class.approved]="req.status === 'Aprobado' || req.status === 'APROBADA'">
                                <span class="dot"></span> {{ req.status }}
                            </span>
                        </td>
                        <td class="text-center">
                            <button class="btn-review" (click)="openReviewModal(req)">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="8" x2="12" y2="12"></line>
                                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                </svg>
                                Revisar
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="pagination-container">
            <div class="items-per-page">
                <span>Mostrar</span>
                <select [(ngModel)]="pageSize" (change)="setPage(1)">
                    <option [value]="10">10</option>
                    <option [value]="20">20</option>
                    <option [value]="50">50</option>
                </select>
                <span>elementos de {{ totalItemsDisplay }}</span>
            </div>

            <div class="page-controls">
                <button class="btn-page text" (click)="setPage(currentPage - 1)"
                    [disabled]="currentPage === 1">Anterior</button>

                <button *ngFor="let p of pagesArray" class="btn-page number" [class.active]="p === currentPage"
                    (click)="setPage(p)">
                    {{ p }}
                </button>

                <button class="btn-page text" (click)="setPage(currentPage + 1)"
                    [disabled]="currentPage === totalPages">Siguiente</button>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Access Management Modal -->
<app-form-modal *ngIf="showAccessModal" title="Gestión de Accesos y Credenciales" (close)="showAccessModal = false"
    (save)="saveAccess()" saveLabel="Guardar Cambios">

    <p class="modal-description">Administra las credenciales de ingreso y define el estado de actividad de la
        cuenta.</p>

    <div class="form-grid">
        <div class="form-group">
            <label>Usuario</label>
            <input type="text" [(ngModel)]="accessForm.username" disabled class="input-disabled">
        </div>
        <div class="form-group">
            <label>Correo</label>
            <input type="text" [(ngModel)]="accessForm.email" disabled class="input-disabled">
        </div>
        <div class="form-group full-width">
            <label>Nombre Completo</label>
            <input type="text" [(ngModel)]="accessForm.fullName" disabled class="input-disabled">
        </div>


        <div class="form-group">
            <div class="toggle-switch-container">
                <label style="margin-bottom: 8px; display: block;">Cuenta Activa</label>
                <div class="toggle-wrapper">
                    <label class="switch">
                        <input type="checkbox" [(ngModel)]="accessForm.active">
                        <span class="slider round"></span>
                    </label>
                    <span class="status-text">{{ accessForm.active ? 'Activa' : 'Inactiva' }}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-actions">
        <button class="btn-cancel" (click)="showAccessModal = false">Cancelar</button>
        <button class="btn-save" (click)="saveAccess()">Guardar Cambios</button>
    </div>
</app-form-modal>

<!-- Edit Profile Modal -->
<app-form-modal *ngIf="showEditModal" title="Actualizar Datos del Perfil" (close)="showEditModal = false">

    <p class="modal-description">Modifica la información de contacto y datos complementarios del investigador</p>

    <div class="form-grid">
        <div class="form-group full-width">
            <label>Nombre Completo</label>
            <input type="text" [(ngModel)]="editForm.fullName" disabled class="input-disabled">
        </div>
        <div class="form-group">
            <label>Correo Electrónico</label>
            <input type="email" [(ngModel)]="editForm.email">
        </div>
        <div class="form-group">
            <label>Fecha de Nacimiento</label>
            <input type="date" [(ngModel)]="editForm.birthDate">
        </div>

        <div class="form-group full-width">
            <label style="display: block; margin-bottom: 8px;">Sexo</label>
            <div class="radio-group">
                <label class="radio-container" *ngFor="let gender of genders">
                    <input type="radio" name="gender" [value]="gender.codigo" [(ngModel)]="editForm.gender">
                    <span class="radio-mark"></span>
                    <span class="radio-label">{{ gender.nombre }}</span>
                </label>
            </div>
        </div>
    </div>

    <div class="modal-actions">
        <button class="btn-cancel" (click)="showEditModal = false">Cancelar</button>
        <button class="btn-save" (click)="saveEdit()">Guardar Cambios</button>
    </div>
</app-form-modal>

<!-- Review Request Modal -->
<app-form-modal *ngIf="showReviewModal && selectedRequest" title="Atender Solicitud de Anulación"
    (close)="showReviewModal = false">

    <p class="modal-description">Revisa los motivos expuestos por el investigador y determina la procedencia de la
        baja definitiva de la cuenta.</p>

    <div class="form-grid">
        <div class="form-group full-width">
            <label>Investigador</label>
            <input type="text" [value]="selectedRequest.researcherName" disabled class="input-disabled">
        </div>
        <div class="form-group">
            <label>Documento</label>
            <input type="text" [value]="selectedRequest.document" disabled class="input-disabled">
        </div>
        <div class="form-group">
            <label>Correo</label>
            <input type="text" [value]="selectedRequest.email" disabled class="input-disabled">
        </div>
        <div class="form-group full-width">
            <label>Ticket / ID Solicitud</label>
            <input type="text" [value]="selectedRequest.ticketId" disabled class="input-disabled">
        </div>
        <div class="form-group full-width">
            <label>Motivo de investigador</label>
            <textarea class="input-disabled" disabled rows="3">{{ selectedRequest.researcherReasonFull }}</textarea>
        </div>
        <div class="form-group full-width">
            <label>Observación del Administrador <span style="color: red;">*</span></label>
            <textarea rows="3" placeholder="Indica el motivo de la aprobación o rechazo de la solicitud..."
                [(ngModel)]="reviewForm.adminObservation" required #adminObs="ngModel"
                [class.input-error]="adminObs.invalid && (adminObs.dirty || adminObs.touched)"></textarea>
        </div>
    </div>

    <div class="modal-actions">
        <button class="btn-cancel" (click)="showReviewModal = false">Cancelar</button>
        <button class="btn-save" (click)="adminObs.control.markAsTouched(); approveDerecognition(!!adminObs.valid)"
            [disabled]="selectedRequest.status === 'APROBADA' || selectedRequest.status === 'Aprobado'"
            [style.opacity]="(selectedRequest.status === 'APROBADA' || selectedRequest.status === 'Aprobado') ? '0.5' : '1'">
            Aprobar Anulación
        </button>
    </div>
</app-form-modal>
<!-- File Viewer Modal -->
<app-file-viewer-modal *ngIf="showFileViewer" [isOpen]="showFileViewer" [files]="viewerFiles"
    (onClose)="showFileViewer = false">
</app-file-viewer-modal>