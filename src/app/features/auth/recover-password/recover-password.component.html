<div class="recover-container">
    <!-- Left Panel: Branding & Info -->
    <app-auth-branding class="brand-panel"></app-auth-branding>

    <!-- Right Panel: Form Content -->
    <div class="form-panel">

        <!-- Top Navigation -->
        <div class="top-bar">
            <!-- Back Button -->
            <button class="btn-back-link" *ngIf="currentStep > 1" (click)="prevStep()">
                <svg width="6" height="10" viewBox="0 0 6 10" fill="none" xmlns="http://www.w3.org/2000/svg"
                    style="transform: rotate(180deg); margin-right: 5px;">
                    <path d="M1 9L5 5L1 1" stroke="#1F2937" stroke-width="1.5" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
                Volver
            </button>

            <div *ngIf="currentStep === 1"></div> <!-- Spacer to push Home link to right -->

            <!-- Home Link -->
            <a routerLink="/auth/login" class="btn-home">
                Volver a inicio
                <svg width="6" height="10" viewBox="0 0 6 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M1 9L5 5L1 1" stroke="#1F2937" stroke-width="1.5" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
            </a>
        </div>

        <div class="form-wrapper">
            <div class="form-header">
                <h2>Restablecimiento de<br>contrase√±a</h2>
            </div>

            <!-- STEP 1: SEND CODE -->
            <div *ngIf="currentStep === 1">
                <p class="description">
                    Por favor, ingresa el correo electr√≥nico que registraste anteriormente para que podamos enviarte un
                    c√≥digo.
                </p>

                <form [formGroup]="step1Form" (ngSubmit)="onStep1Submit()">
                    <div class="form-group">
                        <div style="position: relative;">
                            <!-- Email Icon -->
                            <span class="input-icon">‚úâÔ∏è</span>
                            <input type="email" class="form-control with-icon" formControlName="email"
                                placeholder="ej. enzo@gmail.com"
                                [class.is-invalid]="step1Form.get('email')?.invalid && (step1Form.get('email')?.dirty || step1Form.get('email')?.touched)">
                        </div>
                        <div class="invalid-feedback"
                            *ngIf="step1Form.get('email')?.invalid && (step1Form.get('email')?.dirty || step1Form.get('email')?.touched)"
                            style="display: block;">
                            <span *ngIf="step1Form.get('email')?.errors?.['required']">El correo es requerido</span>
                            <span *ngIf="step1Form.get('email')?.errors?.['email']">Ingresa un correo v√°lido (ej.
                                usuario@dominio.com)</span>
                        </div>
                    </div>

                    <div *ngIf="step1Error"
                        style="position: relative; color: #b91c1c; background-color: #fef2f2; border: 1px solid #f87171; padding: 0.75rem; border-radius: 6px; font-size: 0.9rem; margin-top: 1rem; text-align: center;">
                        {{ step1Error }}
                        <span (click)="step1Error = null" title="Cerrar"
                            style="position: absolute; top: 4px; right: 8px; cursor: pointer; font-weight: bold; font-size: 1.2rem; line-height: 1; color: #991b1b;">
                            &times;
                        </span>
                    </div>

                    <button type="submit" class="btn btn-primary mt-4" [disabled]="step1Form.invalid || isLoading">
                        {{ isLoading ? 'Enviando...' : 'Enviar c√≥digo' }}
                    </button>
                </form>
            </div>

            <!-- STEP 2: VERIFY CODE -->
            <div *ngIf="currentStep === 2">
                <p class="description">
                    Si el correo ingresado coincide con un registro activo, hemos enviado un c√≥digo de verificaci√≥n. Por
                    favor ingr√©salo a continuaci√≥n.
                </p>

                <form [formGroup]="step2Form" (ngSubmit)="onStep2Submit()">
                    <div class="form-group">
                        <input type="text" class="form-control text-center code-input" formControlName="code"
                            placeholder="XXXXXX" maxlength="6" appOnlyNumbers (input)="step2Error = null">

                        <div style="text-align: right; margin-top: 5px;">
                            <a href="javascript:void(0)" (click)="resendCode()" class="link-teal"
                                title="Haz click a este enlace para reenviar el c√≥digo"
                                [style.pointer-events]="((timeLeft$ | async) || 0) > 0 ? 'none' : 'auto'"
                                [style.opacity]="((timeLeft$ | async) || 0) > 0 ? '0.6' : '1'"
                                style="font-size: 0.85rem; cursor: pointer;">
                                {{ ((timeLeft$ | async) || 0) > 0 ? 'Reenviar c√≥digo (' + (timeLeft$ | async) + 's)' :
                                'Reenviar c√≥digo' }}
                            </a>
                        </div>
                    </div>

                    <div *ngIf="step2Error"
                        style="position: relative; color: #b91c1c; background-color: #fef2f2; border: 1px solid #f87171; padding: 0.75rem; border-radius: 6px; font-size: 0.9rem; margin-top: 1rem; text-align: center;">
                        {{ step2Error }}
                        <span (click)="step2Error = null" title="Cerrar"
                            style="position: absolute; top: 4px; right: 8px; cursor: pointer; font-weight: bold; font-size: 1.2rem; line-height: 1; color: #991b1b;">
                            &times;
                        </span>
                    </div>

                    <button type="submit" class="btn btn-primary mt-4" [disabled]="step2Form.invalid">
                        Validar c√≥digo
                    </button>
                </form>
            </div>

            <!-- STEP 3: RESET PASSWORD -->
            <div *ngIf="currentStep === 3">
                <p class="description">
                    Aqu√≠ puedes ingresar tu nueva contrase√±a. Aseg√∫rate de que sea segura y f√°cil de recordar.
                </p>

                <form [formGroup]="step3Form" (ngSubmit)="onSubmit()">
                    <div class="form-group">
                        <label class="form-label">Contrase√±a <span class="required">*</span> <span class="info-icon"
                                title="Requisitos de seguridad">?</span></label>
                        <div style="position: relative;">
                            <input [type]="showPassword ? 'text' : 'password'" class="form-control"
                                formControlName="password" placeholder="XXXXXX" appPasswordStrength
                                #strength="appPasswordStrength"
                                [class.is-invalid]="step3Form.get('password')?.invalid && (step3Form.get('password')?.dirty || step3Form.get('password')?.touched)">
                            <button type="button" class="btn-eye" (click)="togglePasswordVisibility()">
                                {{ showPassword ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è' }}
                            </button>
                        </div>

                        <!-- Password Strength Checklist -->
                        <ul class="password-requirements" *ngIf="step3Form.get('password')?.value">
                            <li [class.completed]="strength.hasMinLength">
                                Utiliza al menos 8 caracteres para tu contrase√±a.
                            </li>
                            <li [class.completed]="strength.hasLowerCase">
                                Incluye una letra min√∫scula (a-z).
                            </li>
                            <li [class.completed]="strength.hasUpperCase">
                                Agrega una letra may√∫scula (A-Z).
                            </li>
                            <li [class.completed]="strength.hasSpecialChar">
                                Al menos 1 car√°cter especial (@, #, $, %, etc.).
                            </li>
                            <li [class.completed]="strength.hasNumber">
                                Incluye un n√∫mero (0-9).
                            </li>
                        </ul>

                        <div class="invalid-feedback"
                            *ngIf="step3Form.get('password')?.invalid && (step3Form.get('password')?.dirty || step3Form.get('password')?.touched)">
                            <span *ngIf="step3Form.get('password')?.errors?.['required']">La contrase√±a es
                                requerida</span>
                            <span *ngIf="step3Form.get('password')?.errors?.['minlength']">M√≠nimo 8 caracteres</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Confirmar contrase√±a <span class="required">*</span></label>
                        <div style="position: relative;">
                            <input [type]="showConfirmPassword ? 'text' : 'password'" class="form-control"
                                formControlName="confirmPassword" placeholder="XXXXXX">
                            <button type="button" class="btn-eye" (click)="toggleConfirmPasswordVisibility()">
                                {{ showConfirmPassword ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è' }}
                            </button>
                        </div>
                        <div class="invalid-feedback"
                            *ngIf="step3Form.hasError('notSame') && step3Form.get('confirmPassword')?.dirty"
                            style="display:block; color: #DC2626; font-size: 0.8rem; margin-top: 4px;">
                            Las contrase√±as no coinciden.
                        </div>
                    </div>

                    <div *ngIf="step3Error"
                        style="position: relative; color: #b91c1c; background-color: #fef2f2; border: 1px solid #f87171; padding: 0.75rem; border-radius: 6px; font-size: 0.9rem; margin-top: 1rem; text-align: center;">
                        {{ step3Error }}
                        <span (click)="step3Error = null" title="Cerrar"
                            style="position: absolute; top: 4px; right: 8px; cursor: pointer; font-weight: bold; font-size: 1.2rem; line-height: 1; color: #991b1b;">
                            &times;
                        </span>
                    </div>

                    <!-- Button disabled until form is valid AND robustness rules passed -->
                    <button type="submit" class="btn btn-primary mt-4"
                        [disabled]="step3Form.invalid || !strength.hasMinLength || !strength.hasLowerCase || !strength.hasUpperCase || !strength.hasNumber || !strength.hasSpecialChar">
                        Guardar cambios
                    </button>
                </form>
            </div>

            <!-- FOOTER -->
            <div class="divider">
                <span>o</span>
            </div>

            <div class="form-footer">
                ¬øYa tienes una cuenta? <a routerLink="/auth/login" class="link-teal">Iniciar Sesi√≥n</a>
            </div>

        </div>
    </div>
</div>